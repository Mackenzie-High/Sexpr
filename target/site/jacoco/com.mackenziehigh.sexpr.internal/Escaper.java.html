<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Escaper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">sexpr</a> &gt; <a href="index.source.html" class="el_package">com.mackenziehigh.sexpr.internal</a> &gt; <span class="el_source">Escaper.java</span></div><h1>Escaper.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2017 Michael Mackenzie High
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
package com.mackenziehigh.sexpr.internal;

import java.util.Arrays;

/**
 * Escaper.
 *
 * &lt;p&gt;
 * Herein, an escape sequence is any one of the following substrings:
 * &lt;/p&gt;
 * &lt;ul&gt;
 * &lt;li&gt;\b&lt;/li&gt;
 * &lt;li&gt;\t&lt;/li&gt;
 * &lt;li&gt;\n&lt;/li&gt;
 * &lt;li&gt;\f&lt;/li&gt;
 * &lt;li&gt;\r&lt;/li&gt;
 * &lt;li&gt;\'&lt;/li&gt;
 * &lt;li&gt;\&quot;&lt;/li&gt;
 * &lt;li&gt;\\&lt;/li&gt;
 * &lt;li&gt;\ uWXYZ, where WXYZ is a four-digit hexadecimal Unicode character code.&lt;/li&gt;
 * &lt;/ul&gt;
 */
public final class Escaper
{
    /**
     * This is the singleton instance of this class.
     */
<span class="fc" id="L43">    public static final Escaper instance = new Escaper();</span>

    /**
     * Lookup Table.
     */
<span class="fc" id="L48">    private static final String[] ASCII = new String[128];</span>

    static
    {
<span class="fc" id="L52">        ASCII['\b'] = &quot;\\b&quot;;</span>
<span class="fc" id="L53">        ASCII['\t'] = &quot;\\t&quot;;</span>
<span class="fc" id="L54">        ASCII['\n'] = &quot;\\n&quot;;</span>
<span class="fc" id="L55">        ASCII['\f'] = &quot;\\f&quot;;</span>
<span class="fc" id="L56">        ASCII['\r'] = &quot;\\r&quot;;</span>
<span class="fc" id="L57">        ASCII[34] = &quot;\\\&quot;&quot;;</span>
<span class="fc" id="L58">        ASCII[39] = &quot;\\'&quot;;</span>
<span class="fc" id="L59">        ASCII[92] = &quot;\\\\&quot;;</span>

        /**
         * Normal Characters.
         */
<span class="fc" id="L64">        ASCII[32] = Character.toString((char) 32);</span>
<span class="fc" id="L65">        ASCII[33] = &quot;!&quot;;</span>
        //
<span class="fc" id="L67">        ASCII[35] = &quot;#&quot;;</span>
<span class="fc" id="L68">        ASCII[36] = &quot;$&quot;;</span>
<span class="fc" id="L69">        ASCII[37] = &quot;%&quot;;</span>
<span class="fc" id="L70">        ASCII[38] = &quot;&amp;&quot;;</span>
        //
<span class="fc" id="L72">        ASCII[40] = &quot;(&quot;;</span>
<span class="fc" id="L73">        ASCII[41] = &quot;)&quot;;</span>
<span class="fc" id="L74">        ASCII[42] = &quot;*&quot;;</span>
<span class="fc" id="L75">        ASCII[43] = &quot;+&quot;;</span>
<span class="fc" id="L76">        ASCII[44] = &quot;,&quot;;</span>
<span class="fc" id="L77">        ASCII[45] = &quot;-&quot;;</span>
<span class="fc" id="L78">        ASCII[46] = &quot;.&quot;;</span>
<span class="fc" id="L79">        ASCII[47] = &quot;/&quot;;</span>
<span class="fc" id="L80">        ASCII[48] = &quot;0&quot;;</span>
<span class="fc" id="L81">        ASCII[49] = &quot;1&quot;;</span>
<span class="fc" id="L82">        ASCII[50] = &quot;2&quot;;</span>
<span class="fc" id="L83">        ASCII[51] = &quot;3&quot;;</span>
<span class="fc" id="L84">        ASCII[52] = &quot;4&quot;;</span>
<span class="fc" id="L85">        ASCII[53] = &quot;5&quot;;</span>
<span class="fc" id="L86">        ASCII[54] = &quot;6&quot;;</span>
<span class="fc" id="L87">        ASCII[55] = &quot;7&quot;;</span>
<span class="fc" id="L88">        ASCII[56] = &quot;8&quot;;</span>
<span class="fc" id="L89">        ASCII[57] = &quot;9&quot;;</span>
<span class="fc" id="L90">        ASCII[58] = &quot;:&quot;;</span>
<span class="fc" id="L91">        ASCII[59] = &quot;;&quot;;</span>
<span class="fc" id="L92">        ASCII[60] = &quot;&lt;&quot;;</span>
<span class="fc" id="L93">        ASCII[61] = &quot;=&quot;;</span>
<span class="fc" id="L94">        ASCII[62] = &quot;&gt;&quot;;</span>
<span class="fc" id="L95">        ASCII[63] = &quot;?&quot;;</span>
<span class="fc" id="L96">        ASCII[64] = &quot;@&quot;;</span>
<span class="fc" id="L97">        ASCII[65] = &quot;A&quot;;</span>
<span class="fc" id="L98">        ASCII[66] = &quot;B&quot;;</span>
<span class="fc" id="L99">        ASCII[67] = &quot;C&quot;;</span>
<span class="fc" id="L100">        ASCII[68] = &quot;D&quot;;</span>
<span class="fc" id="L101">        ASCII[69] = &quot;E&quot;;</span>
<span class="fc" id="L102">        ASCII[70] = &quot;F&quot;;</span>
<span class="fc" id="L103">        ASCII[71] = &quot;G&quot;;</span>
<span class="fc" id="L104">        ASCII[72] = &quot;H&quot;;</span>
<span class="fc" id="L105">        ASCII[73] = &quot;I&quot;;</span>
<span class="fc" id="L106">        ASCII[74] = &quot;J&quot;;</span>
<span class="fc" id="L107">        ASCII[75] = &quot;K&quot;;</span>
<span class="fc" id="L108">        ASCII[76] = &quot;L&quot;;</span>
<span class="fc" id="L109">        ASCII[77] = &quot;M&quot;;</span>
<span class="fc" id="L110">        ASCII[78] = &quot;N&quot;;</span>
<span class="fc" id="L111">        ASCII[79] = &quot;O&quot;;</span>
<span class="fc" id="L112">        ASCII[80] = &quot;P&quot;;</span>
<span class="fc" id="L113">        ASCII[81] = &quot;Q&quot;;</span>
<span class="fc" id="L114">        ASCII[82] = &quot;R&quot;;</span>
<span class="fc" id="L115">        ASCII[83] = &quot;S&quot;;</span>
<span class="fc" id="L116">        ASCII[84] = &quot;T&quot;;</span>
<span class="fc" id="L117">        ASCII[85] = &quot;U&quot;;</span>
<span class="fc" id="L118">        ASCII[86] = &quot;V&quot;;</span>
<span class="fc" id="L119">        ASCII[87] = &quot;W&quot;;</span>
<span class="fc" id="L120">        ASCII[88] = &quot;X&quot;;</span>
<span class="fc" id="L121">        ASCII[89] = &quot;Y&quot;;</span>
<span class="fc" id="L122">        ASCII[90] = &quot;Z&quot;;</span>
<span class="fc" id="L123">        ASCII[91] = &quot;[&quot;;</span>
        //
<span class="fc" id="L125">        ASCII[93] = &quot;]&quot;;</span>
<span class="fc" id="L126">        ASCII[94] = &quot;^&quot;;</span>
<span class="fc" id="L127">        ASCII[95] = &quot;_&quot;;</span>
<span class="fc" id="L128">        ASCII[96] = &quot;`&quot;;</span>
<span class="fc" id="L129">        ASCII[97] = &quot;a&quot;;</span>
<span class="fc" id="L130">        ASCII[98] = &quot;b&quot;;</span>
<span class="fc" id="L131">        ASCII[99] = &quot;c&quot;;</span>
<span class="fc" id="L132">        ASCII[100] = &quot;d&quot;;</span>
<span class="fc" id="L133">        ASCII[101] = &quot;e&quot;;</span>
<span class="fc" id="L134">        ASCII[102] = &quot;f&quot;;</span>
<span class="fc" id="L135">        ASCII[103] = &quot;g&quot;;</span>
<span class="fc" id="L136">        ASCII[104] = &quot;h&quot;;</span>
<span class="fc" id="L137">        ASCII[105] = &quot;i&quot;;</span>
<span class="fc" id="L138">        ASCII[106] = &quot;j&quot;;</span>
<span class="fc" id="L139">        ASCII[107] = &quot;k&quot;;</span>
<span class="fc" id="L140">        ASCII[108] = &quot;l&quot;;</span>
<span class="fc" id="L141">        ASCII[109] = &quot;m&quot;;</span>
<span class="fc" id="L142">        ASCII[110] = &quot;n&quot;;</span>
<span class="fc" id="L143">        ASCII[111] = &quot;o&quot;;</span>
<span class="fc" id="L144">        ASCII[112] = &quot;p&quot;;</span>
<span class="fc" id="L145">        ASCII[113] = &quot;q&quot;;</span>
<span class="fc" id="L146">        ASCII[114] = &quot;r&quot;;</span>
<span class="fc" id="L147">        ASCII[115] = &quot;s&quot;;</span>
<span class="fc" id="L148">        ASCII[116] = &quot;t&quot;;</span>
<span class="fc" id="L149">        ASCII[117] = &quot;u&quot;;</span>
<span class="fc" id="L150">        ASCII[118] = &quot;v&quot;;</span>
<span class="fc" id="L151">        ASCII[119] = &quot;w&quot;;</span>
<span class="fc" id="L152">        ASCII[120] = &quot;x&quot;;</span>
<span class="fc" id="L153">        ASCII[121] = &quot;y&quot;;</span>
<span class="fc" id="L154">        ASCII[122] = &quot;z&quot;;</span>
<span class="fc" id="L155">        ASCII[123] = &quot;{&quot;;</span>
<span class="fc" id="L156">        ASCII[124] = &quot;|&quot;;</span>
<span class="fc" id="L157">        ASCII[125] = &quot;}&quot;;</span>
<span class="fc" id="L158">        ASCII[126] = &quot;~&quot;;</span>
<span class="fc" id="L159">    }</span>

    /**
     * Sole Constructor.
     */
    private Escaper ()
    {
        // Pass
    }

    /**
     * This method creates a string from a char-array,
     * with each special-character replaced with
     * a relevant escape sequence.
     *
     * @param input will be converted to a string.
     * @return the new string.
     */
    public String escape (final char[] input)
    {
<span class="fc" id="L179">        final StringBuilder str = new StringBuilder();</span>

<span class="fc bfc" id="L181" title="All 2 branches covered.">        for (int i = 0; i &lt; input.length; i++)</span>
        {
<span class="fc" id="L183">            final char chr = input[i];</span>

<span class="fc bfc" id="L185" title="All 2 branches covered.">            if (chr == '\b')</span>
            {
<span class="fc" id="L187">                str.append(&quot;\\b&quot;);</span>
            }
<span class="fc bfc" id="L189" title="All 2 branches covered.">            else if (chr == '\t')</span>
            {
<span class="fc" id="L191">                str.append(&quot;\\t&quot;);</span>
            }
<span class="fc bfc" id="L193" title="All 2 branches covered.">            else if (chr == '\n')</span>
            {
<span class="fc" id="L195">                str.append(&quot;\\n&quot;);</span>
            }
<span class="fc bfc" id="L197" title="All 2 branches covered.">            else if (chr == '\f')</span>
            {
<span class="fc" id="L199">                str.append(&quot;\\f&quot;);</span>
            }
<span class="fc bfc" id="L201" title="All 2 branches covered.">            else if (chr == '\r')</span>
            {
<span class="fc" id="L203">                str.append(&quot;\\r&quot;);</span>
            }
<span class="fc bfc" id="L205" title="All 2 branches covered.">            else if (chr == '\'')</span>
            {
<span class="fc" id="L207">                str.append(&quot;\\\'&quot;);</span>
            }
<span class="fc bfc" id="L209" title="All 2 branches covered.">            else if (chr == '\&quot;')</span>
            {
<span class="fc" id="L211">                str.append(&quot;\\\&quot;&quot;);</span>
            }
<span class="fc bfc" id="L213" title="All 2 branches covered.">            else if (chr == '\\')</span>
            {
<span class="fc" id="L215">                str.append(&quot;\\\\&quot;);</span>
            }
<span class="fc bfc" id="L217" title="All 4 branches covered.">            else if (chr &lt; ASCII.length &amp;&amp; ASCII[chr] != null)</span>
            {
<span class="fc" id="L219">                str.append(ASCII[chr]);</span>
            }
            else
            {
<span class="fc" id="L223">                str.append(String.format(&quot;\\u%04X&quot;, (int) chr));</span>
            }
        }

<span class="fc" id="L227">        return str.toString();</span>
    }

    /**
     * This method replaces escape sequences in a string
     * with the equivalent special-characters and then
     * returns the equivalent char-array.
     *
     * &lt;p&gt;
     * In short, X.equals(expand(escape(X))).
     * &lt;/p&gt;
     *
     * @param input is an escaped string.
     * @return the non-escaped char-array.
     */
    public char[] expand (final String input)
    {
<span class="fc" id="L244">        final char[] chars = input.toCharArray();</span>

<span class="fc" id="L246">        final char[] temp = new char[chars.length];</span>

<span class="fc" id="L248">        int i = 0; // position in the input</span>
<span class="fc" id="L249">        int k = 0; // position in the output</span>

<span class="fc bfc" id="L251" title="All 2 branches covered.">        while (i &lt; chars.length)</span>
        {
<span class="fc" id="L253">            final int remaining = chars.length - i;</span>

<span class="pc bpc" id="L255" title="1 of 4 branches missed.">            final boolean slash = remaining &gt;= 1 &amp;&amp; chars[i] == '\\';</span>

<span class="pc bpc" id="L257" title="1 of 4 branches missed.">            if (slash &amp;&amp; remaining == 0)</span>
            {
<span class="nc" id="L259">                throw new IllegalArgumentException(&quot;Escape Slash at End of String&quot;);</span>
            }

            /**
             * Detect the two-character escape-sequences.
             */
<span class="fc bfc" id="L265" title="All 6 branches covered.">            final boolean s1 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == 'b';</span>
<span class="fc bfc" id="L266" title="All 6 branches covered.">            final boolean s2 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == 't';</span>
<span class="fc bfc" id="L267" title="All 6 branches covered.">            final boolean s3 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == 'n';</span>
<span class="fc bfc" id="L268" title="All 6 branches covered.">            final boolean s4 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == 'f';</span>
<span class="fc bfc" id="L269" title="All 6 branches covered.">            final boolean s5 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == 'r';</span>
<span class="fc bfc" id="L270" title="All 6 branches covered.">            final boolean s6 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == '\\';</span>
<span class="fc bfc" id="L271" title="All 6 branches covered.">            final boolean s7 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == '\'';</span>
<span class="fc bfc" id="L272" title="All 6 branches covered.">            final boolean s8 = slash &amp;&amp; remaining &gt;= 2 &amp;&amp; chars[i + 1] == '\&quot;';</span>

            /**
             * Detect the hexadecimal Unicode escape-sequences.
             */
<span class="fc bfc" id="L277" title="All 6 branches covered.">            final boolean d0 = slash &amp;&amp; remaining &gt;= 6 &amp;&amp; chars[i + 1] == 'u';</span>
<span class="fc bfc" id="L278" title="All 6 branches covered.">            final boolean d1 = slash &amp;&amp; remaining &gt;= 6 &amp;&amp; isHex(chars[i + 2]);</span>
<span class="fc bfc" id="L279" title="All 6 branches covered.">            final boolean d2 = slash &amp;&amp; remaining &gt;= 6 &amp;&amp; isHex(chars[i + 3]);</span>
<span class="fc bfc" id="L280" title="All 6 branches covered.">            final boolean d3 = slash &amp;&amp; remaining &gt;= 6 &amp;&amp; isHex(chars[i + 4]);</span>
<span class="fc bfc" id="L281" title="All 6 branches covered.">            final boolean d4 = slash &amp;&amp; remaining &gt;= 6 &amp;&amp; isHex(chars[i + 5]);</span>

<span class="fc bfc" id="L283" title="All 20 branches covered.">            if (slash &amp;&amp; !d0 &amp;&amp; !s1 &amp;&amp; !s2 &amp;&amp; !s3 &amp;&amp; !s4 &amp;&amp; !s5 &amp;&amp; !s6 &amp;&amp; !s7 &amp;&amp; !s8)</span>
            {
<span class="fc" id="L285">                throw new IllegalArgumentException(&quot;No Such Escape Sequence&quot;);</span>
            }

<span class="pc bpc" id="L288" title="3 of 12 branches missed.">            if (slash &amp;&amp; d0 &amp;&amp; (!d1 || !d2 || !d3 || !d4))</span>
            {
<span class="fc" id="L290">                throw new IllegalArgumentException(&quot;Invalid Unicode Escape Sequence&quot;);</span>
            }

            /**
             * If the character is not part of an escape sequence,
             * then take the character itself.
             */
<span class="fc" id="L297">            char r = chars[i];</span>

            /**
             * Replace escape-sequences with their expansions.
             */
<span class="fc bfc" id="L302" title="All 2 branches covered.">            r = s1 ? '\b' : r;</span>
<span class="fc bfc" id="L303" title="All 2 branches covered.">            r = s2 ? '\t' : r;</span>
<span class="fc bfc" id="L304" title="All 2 branches covered.">            r = s3 ? '\n' : r;</span>
<span class="fc bfc" id="L305" title="All 2 branches covered.">            r = s4 ? '\f' : r;</span>
<span class="fc bfc" id="L306" title="All 2 branches covered.">            r = s5 ? '\r' : r;</span>
<span class="fc bfc" id="L307" title="All 2 branches covered.">            r = s6 ? '\\' : r;</span>
<span class="fc bfc" id="L308" title="All 2 branches covered.">            r = s7 ? '\'' : r;</span>
<span class="fc bfc" id="L309" title="All 2 branches covered.">            r = s8 ? '\&quot;' : r;</span>
<span class="pc bpc" id="L310" title="4 of 10 branches missed.">            r = d0 &amp;&amp; d1 &amp;&amp; d2 &amp;&amp; d3 &amp;&amp; d4 ? (char) Integer.parseInt(&quot;&quot; + chars[i + 2] + chars[i + 3] + chars[i + 4] + chars[i + 5], 16) : r;</span>

            /**
             * Append the character onto the output.
             */
<span class="fc" id="L315">            temp[k++] = r;</span>

            /**
             * Advance forward.
             * 6 = Unicode Escape Sequence
             * 2 = Two Character Escape Sequence
             * 1 = No Escape Sequence
             */
<span class="fc bfc" id="L323" title="All 4 branches covered.">            i += slash ? (d0 ? 6 : 2) : 1;</span>
<span class="fc" id="L324">        }</span>

<span class="fc" id="L326">        final char[] result = Arrays.copyOf(temp, k);</span>

<span class="fc" id="L328">        return result;</span>
    }

    private boolean isHex (final char value)
    {
<span class="fc bfc" id="L333" title="All 2 branches covered.">        switch (value)</span>
        {
            case '0':
            case '1':
            case '2':
            case '3':
            case '4':
            case '5':
            case '6':
            case '7':
            case '8':
            case '9':
            case 'A':
            case 'B':
            case 'C':
            case 'D':
            case 'E':
            case 'F':
<span class="fc" id="L351">                return true;</span>
            default:
<span class="fc" id="L353">                return false;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>